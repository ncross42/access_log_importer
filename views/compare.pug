extends layout

block content
  h1
    a(href="/compare", style={'text-decoration':'none'})= title

  div.well.well-sm
    form.form-inline(name="formCompare", method="get")
      //div.form-group.well.well-sm
         label.radio-inline
          input(type="radio",name="basis",value="daily",checked=basis=="daily")
          | 일간
        label.radio-inline
          input(type="radio",name="basis",value="weekly",checked=basis=="weekly")
          | 주간
        label.radio-inline
          input(type="radio",name="basis",value="monthy",checked=basis=="monthy")
          | 월간
      div.form-group
        span(style={'padding-left':'10px','padding-right':'10px','font-size':'1.0em','font-weight':'bold'}) 기간
        input(id="textStart",type="date", name="start", style={'width':'140px'}, value=start)
        span(style={'padding-left':'10px','padding-right':'10px','font-size':'1.0em','font-weight':'bold'}) ~
        input(id="textEnd",type="date", name="end", style={'width':'140px'}, value=end)
      input.btn.btn-default(id="btnSubmit", type="button", value="검색",style={'margin-left':'10px'})

  style.
    #tableSummary th {
      text-align: center;
    }
    #tableSummary td {
      text-align: right;
    }

  div.container
    table.table.table-bordered.table-hover(id="tableSummary")
      thead
        tr
          th
          th(colspan=5) 곰플레이어
          th(colspan=5) 곰오디오
        tr
          th 년도
          th 일평균 다운로드
          th 일평균 삭제
          th 삭제율
          th 기간누적 다운로드
          th 기간누적 삭제
          th 일평균 다운로드
          th 일평균 삭제
          th 삭제율
          th 누적 다운로드
          th 누적 삭제
      tbody


  div#container(style={width:'100%', height:'400px'}) div#container

  script.
    function reload_chart(data) {
      let options = {
        chart: { renderTo: 'container', type: 'spline' },
        title: { text: '#{title} 표' },
        xAxis: { title: { text: '기간' }, categories: data.x_categories },
        yAxis: { title: { text: 'Fruit eaten' }, },
        series: data.series
      };
      new Highcharts.Chart(options);
    }

    /* summary = { 
    '2016': { 
      player: { download: 757217, uninstall: 57915 },
      audio: { download: 161602, uninstall: 20733 } }
    }, { '2015': { 
      player: { download: 1314783, uninstall: 50606 }, 
      audio: { download: 178346, uninstall: 25651 } 
    }, '2016': { 
      player: { download: 757217, uninstall: 57915 },
      audio: { download: 161602, uninstall: 20733 } }
    }; */
    function reload_table(data) {
      const date_len = data.x_categories.length;
      let $tbody = document.querySelector('#tableSummary tbody');
      $tbody.innerHTML = null;  // reset
      html = '';
      for ( let [year, detail] of Object.entries(data.summary) ) {
        html += '<tr><td>'+year+'</td>';
        for ( let [product, stats] of Object.entries(detail) ) {
          html += '<td>'+(stats.download/date_len).toLocaleString('arab',{maximumFractionDigits:1})+'</td>';
          html += '<td>'+(stats.uninstall/date_len).toLocaleString('arab',{maximumFractionDigits:1})+'</td>';
          html += '<td>'+(100*stats.uninstall/stats.download).toLocaleString('arab',{maximumFractionDigits:1})+'</td>';
          html += '<td>'+(stats.download).toLocaleString()+'</td>';
          html += '<td>'+(stats.uninstall).toLocaleString()+'</td>';
        }
        html += '</tr>';
      }
      $tbody.insertAdjacentHTML('afterbegin', html);
    }

    var reload_page = function() {
      const start = document.querySelector('#textStart').value;
      const end = document.querySelector('#textEnd').value;
      const url = '/compare/data/daily/'+start+'/'+end;
      fetch(url).then(r => r.json())
        .then(data => {
          reload_chart(data);
          reload_table(data);
        })
        .catch(e => console.log("Booo"));
    }

    document.querySelector('#btnSubmit')
      .addEventListener( 'click', e => {
      reload_page();
      e.preventDefault();
    });

    document.addEventListener("DOMContentLoaded", ()=>reload_page() );
